---
title: "NBA_Player_sel_analysis"
output: html_document
---
### Introduction

Normalisescoring rates by standardising to score per 40 min (Kubatko, 2007)
several models have been attempted (Spector 2020). difficult to predict how 5 opponents will perform WITH each otehr and also against an opposition
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
```

## Reading and Cleaning the Raw Data

```{r read in data, include=FALSE}
df_sal <- read_csv("data_raw/2018-19_nba_player-salaries_raw.csv")
df_players <- read_csv("data_raw/2018-19_nba_player-statistics_raw.csv")
df_team_payroll <- read_csv("data_raw/2019-20_nba_team-payroll_raw.csv")
df_team_ptsMP <- read_csv("data_raw/2018-19_nba_team-statistics_2_raw.csv")
df_team_WL <- read_csv("data_raw/2018-19_nba_team-statistics_1_raw.csv")
```

```{r convert payroll(cha) to num and scale, include=FALSE}
df_team_payroll$COL1 <- as.numeric(gsub('[$,]', '', df_team_payroll$salary))
df_team_payroll <- mutate(df_team_payroll, COL2 = COL1/1000000)
```

Add standardised team scoring rate per 40min period (Kubatko, 2007), and win%
```{r add column, include=FALSE}
df_team_pts40 <- mutate(df_team_ptsMP, team_pts40 = (PTS / MP)* 40 )
```


[This is a link to the data fields](https://uclearn.canberra.edu.au/courses/9531/pages/data-description-reproducible-data-analysis-project)

**Chicago Bulls payroll is 24th or the 30 NBA teams**
```{r}
# Barplot team payrolls
team_sal <- ggplot(data = df_team_payroll, aes(x = reorder(team, COL2), y = COL2)) +
  geom_bar(stat="identity")
# Horizontal bar plot
new <- team_sal + coord_flip(ylim = c(50, 160))
#label axes
new + labs(title = "Team payroll (2018-19)", face = "italics", x = "Team", y = "Millions") 
```
**Win % versus team salary**
```{r barplot}
df_team_WL <- mutate(df_team_WL, winP = (W / (W + L)* 100))
#add win% column
df_team_pts40 <- bind_cols(df_team_pts40, df_team_WL[-c(1:25)])
# team average pts per minute
team_pts40 <- ggplot(data = df_team_pts40, aes(x = reorder(Team, winP), y = winP)) +
  geom_bar(stat="identity")
# Horizontal bar plot
new1 <- team_pts40 + coord_flip(ylim = c(20, 75)) +
  labs(title = "Team game win percentages (2018-19)", x = "Team", y = "Win %")
new1
```



**Chicago Bulls are ranked 29th of 30 in season average points scored per minute played**
```{r barplot}
# team average pts per minute
ggteam_pts40 <- ggplot(data = df_team_pts40, aes(x = reorder(Team, team_pts40), y = team_pts40)) +
  geom_bar(stat="identity")
# Horizontal bar plot
new2 <- ggteam_pts40 + coord_flip(ylim = c(17, 20)) +
  labs(title = "Team average points scored per 40 minutes played (2018-19)", x = "Team", y = "Points / 40 Minutes")
new2
```
*standardise variables to events per 40min*
```{r establish new variables}
df_team_pts40 <- mutate(df_team_pts40, AST40 = (AST / MP)* 40)
df_team_pts40 <- mutate(df_team_pts40, TOV40 = (TOV / MP)* 40)
df_team_pts40 <- mutate(df_team_pts40, STL40 = (STL / MP)* 40)
df_team_pts40 <- mutate(df_team_pts40, BLK40 = (BLK / MP)* 40)
df_team_pts40 <- mutate(df_team_pts40, PF40 = (PF / MP)* 40)
df_team_pts40 <- mutate(df_team_pts40, TRB40 = (TRB / MP)* 40)
df_team_pts40 <- mutate(df_team_pts40, ORB40 = (ORB / MP)* 40)
df_team_pts40 <- mutate(df_team_pts40, DRB40 = (DRB / MP)* 40)
df_team_pts40 <- mutate(df_team_pts40, FG40 = (FG / MP)* 40)
df_team_pts40 <- mutate(df_team_pts40, FGA40 = (FGA / MP)* 40)
```


**correlation wins and points scored**
```{r}

#points/40 vs win%
df_team_pts40 %>%
  ggplot(aes(x = team_pts40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$team_pts40, y = df_team_pts40$winP, method = "pearson")

#assists vs win%
df_team_pts40 %>%
  ggplot(aes(x = AST40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$AST40, y = df_team_pts40$winP, method = "pearson")

#turnovers vs win%
df_team_pts40 %>%
  ggplot(aes(x = TOV40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$TOV40, y = df_team_pts40$winP, method = "pearson")

#steals vs win%
df_team_pts40 %>%
  ggplot(aes(x = STL40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$STL40, y = df_team_pts40$winP, method = "pearson")

#blocks vs win%
df_team_pts40 %>%
  ggplot(aes(x = BLK40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$BLK40, y = df_team_pts40$winP, method = "pearson")

#fouls vs win%
df_team_pts40 %>%
  ggplot(aes(x = PF40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$PF40, y = df_team_pts40$winP, method = "pearson")

#total rebounds vs win%
df_team_pts40 %>%
  ggplot(aes(x = TRB40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$TRB40, y = df_team_pts40$winP, method = "pearson")

#ORB vs win%
df_team_pts40 %>%
  ggplot(aes(x = ORB40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$ORB40, y = df_team_pts40$winP, method = "pearson")

#DRB vs win%
df_team_pts40 %>%
  ggplot(aes(x = DRB40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$DRB40, y = df_team_pts40$winP, method = "pearson")

#FG vs win%
df_team_pts40 %>%
  ggplot(aes(x = FG40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$FG40, y = df_team_pts40$winP, method = "pearson")

#FGA vs win%
df_team_pts40 %>%
  ggplot(aes(x = FGA40,y = winP)) + 
  geom_point(colour = "dodgerblue") +
  ylim(0, 100) +
  geom_smooth(method = "lm", colour = "magenta") +
  geom_hline(yintercept = 50, colour = "black", linetype = "dashed")
cor(x = df_team_pts40$FGA40, y = df_team_pts40$winP, method = "pearson")
```

team stats related to pts40
```{r}
#AST40 vs pts40
df_team_pts40 %>%
  ggplot(aes(x = AST40,y = team_pts40)) + 
  geom_point(colour = "dodgerblue") +
  geom_smooth(method = "lm", colour = "magenta")
cor(x = df_team_pts40$AST40, y = df_team_pts40$team_pts40, method = "pearson")

#TOV40 vs pts40
df_team_pts40 %>%
  ggplot(aes(x = TOV40,y = team_pts40)) + 
  geom_point(colour = "dodgerblue") +
  geom_smooth(method = "lm", colour = "magenta")
cor(x = df_team_pts40$TOV40, y = df_team_pts40$team_pts40, method = "pearson")

#STL40 vs pts40
df_team_pts40 %>%
  ggplot(aes(x = STL40,y = team_pts40)) + 
  geom_point(colour = "dodgerblue") +
  geom_smooth(method = "lm", colour = "magenta")
cor(x = df_team_pts40$STL40, y = df_team_pts40$team_pts40, method = "pearson")

#BLK40 vs pts40
df_team_pts40 %>%
  ggplot(aes(x = BLK40,y = team_pts40)) + 
  geom_point(colour = "dodgerblue") +
  geom_smooth(method = "lm", colour = "magenta")
cor(x = df_team_pts40$BLK40, y = df_team_pts40$team_pts40, method = "pearson")

#TRB40 vs pts40
df_team_pts40 %>%
  ggplot(aes(x = TRB40,y = team_pts40)) + 
  geom_point(colour = "dodgerblue") +
  geom_smooth(method = "lm", colour = "magenta")
cor(x = df_team_pts40$TRB40, y = df_team_pts40$team_pts40, method = "pearson")

#DRB vs pts40
df_team_pts40 %>%
  ggplot(aes(x = DRB40,y = team_pts40)) + 
  geom_point(colour = "dodgerblue") +
  geom_smooth(method = "lm", colour = "magenta")
cor(x = df_team_pts40$DRB40, y = df_team_pts40$team_pts40, method = "pearson")

#ORB vs pts40
df_team_pts40 %>%
  ggplot(aes(x = ORB40,y = team_pts40)) + 
  geom_point(colour = "dodgerblue") +
  geom_smooth(method = "lm", colour = "magenta")
cor(x = df_team_pts40$ORB40, y = df_team_pts40$team_pts40, method = "pearson")
```

** choose variables associated with high scoring **
3 explanatory variables associated with win% and total score 40 are:
Points Scored
Assists
Blocks
Total rebounds

**Combine player statistics and player salary data files by *'player names'***
```{r combine files}
# join df_sal & df_pl_stat by "player_name"
df_players <- left_join(x = df_sal, y = df_players, by = c("player_name"))
```


```{r write new file}
write.csv(df_players, file = 'data_processed/2018-19_nba_player-salaries-stats_.csv', row.names = FALSE)
```

Clean processed data file
```{r visualise missing data}
sum(is.na(df_players)) 
naniar::vis_miss(df_players)
#filter out players with no position or game time
df_pl_clean <- drop_na(df_players, Pos)
naniar::vis_miss(df_pl_clean)
```


**Create normalised data by adding variable "points per minute played"**
Explore the data filter out games less than 10 to minimise outliers
```{r}
#ggplot(data = df_players) +
# geom_histogram(mapping = aes(x = salmil), colour = "black", fill = "dodgerblue") +
#  labs(x = "millions", y = "number of players", title = "Player salary distribution per year")

df_players <- mutate(df_players, pts40 = (PTS / MP)* 40)

df_players %>%
  group_by(player_id) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = pts40), colour = "black", fill = "dodgerblue") +
  labs(x = "points per minutes played", y = "number of players", title = "Distribution of points scored per minute played", subtitle = "(games played > 10)")

df_players %>%
  group_by(player_id) %>%
  filter(G > 10) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = pts40), colour = "black", fill = "dodgerblue") +
  labs(x = "points per minutes played", y = "number of players", title = "Distribution of points scored per minute played", subtitle = "(games played > 10)")
```

merge rows, add column sal.mil
```{r}
df_players <- mutate(df_players, salmil = salary / 100000)
```



```{r}
#combine rows with same player names
df_players <- bind_rows(df_players) %>%
   group_by(player_id, player_name, Pos) %>%
   summarise(salmil = mean(salmil, na.rm = TRUE),
              G = sum(G, na.rm = TRUE),
             MP = sum(MP, na.rm = TRUE),
            TRB = sum(TRB, na.rm = TRUE),
            AST = sum(AST, na.rm = TRUE),
            BLK = sum(BLK, na.rm = TRUE),
            PTS = sum(PTS, na.rm = TRUE))

df_players40 <- bind_rows(df_players) %>%
   group_by(player_id, player_name) %>%
   summarise(salmil = mean(salmil, na.rm = TRUE),
              G = sum(G, na.rm = TRUE),
             MP = sum(MP, na.rm = TRUE),
            TRB = sum(TRB, na.rm = TRUE),
            AST = sum(AST, na.rm = TRUE),
            BLK = sum(BLK, na.rm = TRUE),
            PTS = sum(PTS, na.rm = TRUE))

df_players <- mutate(df_players, pts40_ind = (PTS / MP)* 40)
df_players <- mutate(df_players, AST40 = (AST / MP)* 40)
df_players <- mutate(df_players, BLK40 = (BLK / MP)* 40)
df_players <- mutate(df_players, TRB40 = (TRB / MP)* 40)

df_players40 <- mutate(df_players40, pts40_ind = (PTS / MP)* 40)
df_players40 <- mutate(df_players40, AST40 = (AST / MP)* 40)
df_players40 <- mutate(df_players40, BLK40 = (BLK / MP)* 40)
df_players40 <- mutate(df_players40, TRB40 = (TRB / MP)* 40)
```


look for relationships b/t Player positions and Explanatory Variables
```{r look for correlations}

#player group by pts_ind
df_players %>%
  filter(G > 10) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = reorder(Pos, pts40_ind, FUN = median),
                             y = pts40_ind, colour = reorder(Pos, pts40_ind,
                                                              FUN = median))) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

#player group by AST
df_players %>%
  filter(G > 10) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = reorder(Pos, AST40, FUN = median),
                             y = AST40, colour = reorder(Pos, AST40,
                                                              FUN = median))) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

#player group by BLK
df_players %>%
  filter(G > 10) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = reorder(Pos, BLK40, FUN = median),
                             y = BLK40, colour = reorder(Pos, BLK40,
                                                              FUN = median))) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

#player group by TRB
df_players %>%
  filter(G > 10) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = reorder(Pos, TRB40, FUN = median),
                             y = TRB40, colour = reorder(Pos, TRB40,
                                                              FUN = median))) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))
```

```{r}

```

** Test Assumptions **
1. Response variable (team win %) IS continuous
2. Explanatory variables (assists, blocks & total rebounds are continuous integers)
3. Independence: potentially fails due to repeated measures of positions
```{r Independence}
car::durbinWatsonTest(fit)
```
4. Linear relationship
```{r}
car::avPlots(fit)
```


5. Detect Outliers:
```{r}
std_res <- rstandard(fit)
points <- 1:length(std_res)
res_labels <- if_else(abs(std_res) >= 2.5, paste(points), "")

ggplot(data = NULL, aes(x = points, y = std_res)) + geom_point() +
geom_text(aes(label = res_labels), nudge_y = 0.3) + ylim(c(-4,4)) +
geom_hline(yintercept = c(-2.5, 2.5), colour = "red", linetype = "dashed")

lm +
geom_text(aes(label = res_labels), nudge_x = 0.002)
  
```
5. Cooks distance
```{r}
cook <- cooks.distance(fit)
cook_labels <- if_else(cook >= 0.015, paste(points), "")

ggplot(data = NULL, aes(x = points, y = cook)) + geom_point() +
geom_text(aes(label = cook_labels), nudge_y = 0.01)
```
6. Homoscedasticity
```{r}
 res <- residuals(fit)
fitted <- predict(fit)

ggplot(data = NULL, aes(x = fitted, y = res)) +
  geom_point(colour = "dodgerblue") +
  geom_smooth(se = FALSE, colour = "magenta")
  
```
7. Normally distributed residuals
```{r}
ggplot(data = NULL, aes(sample = res)) + stat_qq() + stat_qq_line()
```

8. Multicollinearity
```{r}
#team
pairs(formula = ~ winP + AST40 + BLK40 + TRB40, data = df_team_pts40)

fit <- lm(winP ~ AST40 + BLK40 + TRB40, data = df_team_pts40)
tidy(fit, conf.int = TRUE)

sqrt(car::vif(fit))

head(predict(fit))
```




```{r}
#TRB
df_players %>%
filter(G > 10, Pos %in% c("C", "PF", "PG", "SF", "SG")) %>% 
ggplot() +
geom_histogram(aes(x = TRB40, fill = Pos), colour = "black", bins = 40) + facet_wrap(~Pos, nrow = 5)

#assist
df_players %>%
filter(G > 10, Pos %in% c("C", "PF", "PG", "SF", "SG")) %>% 
ggplot() +
geom_histogram(aes(x = AST40, fill = Pos), colour = "black", bins = 40) + facet_wrap(~Pos, nrow = 5)

#pts40
df_players %>%
filter(G > 10, Pos %in% c("C", "PF", "PG", "SF", "SG")) %>% 
ggplot() +
geom_histogram(aes(x = pts40_ind, fill = Pos), colour = "black", bins = 40) + facet_wrap(~Pos, nrow = 5)
# create panels by match_outcome
```

```{r}
df_players %>%
  filter(G > 10) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = reorder(Pos, AST40, FUN = median),
                             y = AST40, colour = reorder(Pos, AST40,
                                                              FUN = median))) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

#salary by points per minutes played
df_players40 %>% filter(G > 10, PTS > 0) %>% group_by(player_id) %>%
  ggplot(mapping = aes(x = salmil, y = pts40_ind)) + 
  geom_point()

#salary by points per minutes played
df_players %>% filter(G > 10) %>% group_by(player_id) %>%
  ggplot(mapping = aes(x = salmil, y = pts40_ind, colour = Pos)) + 
  geom_point()

#player group by salmil
df_players %>%
  filter(G > 10) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = reorder(Pos, salmil, FUN = median),
                             y = salmil, colour = reorder(Pos, salmil,
                                                              FUN = median))) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
